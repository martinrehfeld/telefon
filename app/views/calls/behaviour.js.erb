Event.observe(window, 'load', function(){
  // activate destination field for immediate entry
  Form.Element.activate('call_destination');

  // populate call history if present
  if($('call-history-placeholder')) {
    $('call-history-headline').show();
    <%= remote_function(
      :update   => "call-history-placeholder",
      :url      => history_calls_url,
      :method   => :get,
      :loading  => "$('call-history-busy').style.visibility = 'visible'",
      :complete => "$('call-history-busy').style.visibility = 'hidden'; makePhoneNumbersClickable(); #{visual_effect(:blind_down, "call-history-placeholder", :duration => 3.0)}")
    %>
  }
});

// make all phone-numbers clickable, entering their value into the new_call form

function makePhoneNumbersClickable() {
  $$('.phone-number').each(function(e) {
    e.addClassName('clickable');
    e.observe('click', respondToPhoneNumberClick);
  });

  $$('.phone-name').each(function(e) {
    e.addClassName('clickable');
    e.observe('click', respondToPhoneNameClick);
  });
}

function respondToPhoneNumberClick(event) {
  $('call_destination').value = event.element().innerHTML.gsub(/\+/,'').gsub(/ /,'');
  $('top').scrollTo();
  Form.Element.activate('call_destination');
  return false;
}

function respondToPhoneNameClick(event) {
  var element = event.element().previous('.phone-number');
  if(element) {
    $('call_destination').value = element.innerHTML.gsub(/\+/,'').gsub(/ /,'');
    $('top').scrollTo();
    Form.Element.activate('call_destination');
    return false;
  }
  else {
    return true;
  }
}
